name: Windows RDP with Playit

on:
  workflow_dispatch:
  schedule:
    - cron: '0 */6 * * *'

jobs:
  windows-rdp:
    runs-on: windows-latest
    timeout-minutes: 360

    steps:
    - name: Enable RDP
      run: |
        Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -name "fDenyTSConnections" -value 0
        Enable-NetFirewallRule -DisplayGroup "Remote Desktop"
        net user hacker Password123! /add
        net localgroup administrators hacker /add
        echo "‚úÖ RDP enabled: user=hacker, password=Password123!"

    - name: Setup Playit
      run: |
        # –°–∫–∞—á–∏–≤–∞–µ–º playit
        iwr -uri "https://github.com/playit-cloud/playit-agent/releases/download/v0.16.2/playit-windows-x86_64-signed.exe" -outfile "playit.exe"
        
        # –ó–∞–ø—É—Å–∫–∞–µ–º –ø–æ–ª—É—á–µ–Ω–∏–µ –∫–æ–¥–∞ –≤ —Ñ–æ–Ω–µ –∏ —É–±–∏–≤–∞–µ–º —á–µ—Ä–µ–∑ 5 —Å–µ–∫—É–Ω–¥
        Start-Process -FilePath "playit.exe" -ArgumentList "claim generate" -RedirectStandardOutput "claim.txt" -NoNewWindow
        Start-Sleep -Seconds 5
        Stop-Process -Name "playit" -Force -ErrorAction SilentlyContinue
        
        # –ß–∏—Ç–∞–µ–º –∫–æ–¥ –∏–∑ —Ñ–∞–π–ª–∞
        $code = Get-Content "claim.txt" | Select-String -Pattern "\w+" | ForEach-Object { $_.Matches.Value }
        echo "üîë CLAIM CODE: $code"
        echo ""
        echo "üöÄ NOW GO TO: https://playit.gg/claim"
        echo "üìù ENTER CODE: $code"
        echo ""
        # –ó–∞–ø—É—Å–∫–∞–µ–º –∞–≥–µ–Ω—Ç–∞ –¥–ª—è —Ä–∞–±–æ—Ç—ã
        Start-Process -FilePath "playit.exe" -WindowStyle Hidden

    - name: Wait
      run: |
        echo "‚è≥ Agent started! Complete claim process and setup RDP tunnel..."
        Start-Sleep -Seconds 21600
