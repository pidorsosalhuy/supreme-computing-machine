name: Windows RDP with Playit Claim

on:
  workflow_dispatch:
  schedule:
    - cron: '0 */6 * * *'

jobs:
  windows-rdp:
    runs-on: windows-latest
    timeout-minutes: 360

    steps:
    - name: Enable RDP
      run: |
        Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -name "fDenyTSConnections" -value 0
        Enable-NetFirewallRule -DisplayGroup "Remote Desktop"
        net user hacker Password123! /add
        net localgroup administrators hacker /add
        echo "‚úÖ RDP enabled: user=hacker, password=Password123!"

    - name: Get Playit claim URL
      id: playit
      run: |
        # –°–∫–∞—á–∏–≤–∞–µ–º playit
        iwr -uri "https://github.com/playit-cloud/playit-agent/releases/download/v0.16.2/playit-windows-x86_64-signed.exe" -outfile "playit.exe"
        
        # –ü–æ–ª—É—á–∞–µ–º claim URL (–ø—Ä–∞–≤–∏–ª—å–Ω–∞—è –∫–æ–º–∞–Ω–¥–∞)
        $claim = .\playit.exe claim generate | Out-String
        echo "claim=$claim" >> $env:GITHUB_OUTPUT
        echo "üîó CLAIM URL: $claim"

    - name: Start Playit and wait
      run: |
        echo "üö® IMPORTANT: Go to this URL to connect agent:"
        echo "${{ steps.playit.outputs.claim }}"
        echo ""
        # –ó–∞–ø—É—Å–∫–∞–µ–º playit –ø–æ—Å–ª–µ –ø–æ–ª—É—á–µ–Ω–∏—è claim URL
        Start-Process -FilePath "playit.exe" -WindowStyle Hidden
        echo ""
        echo "–ü–æ—Å–ª–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∞–≥–µ–Ω—Ç–∞:"
        echo "1. –ó–∞–π–¥–∏ –Ω–∞ https://playit.gg"
        echo "2. –í 'Tunnels' —Å–æ–∑–¥–∞–π —Ç—É–Ω–Ω–µ–ª—å –¥–ª—è –ø–æ—Ä—Ç–∞ 3389" 
        echo "3. –ò—Å–ø–æ–ª—å–∑—É–π –ø–æ–ª—É—á–µ–Ω–Ω—É—é —Å—Å—ã–ª–∫—É –¥–ª—è RDP"
        echo ""
        echo "‚è≥ Waiting 6 hours..."
        timeout /t 21600
