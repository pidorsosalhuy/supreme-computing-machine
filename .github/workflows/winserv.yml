name: Windows RDP with Playit Claim

on:
  workflow_dispatch:
  schedule:
    - cron: '0 */6 * * *'

jobs:
  windows-rdp:
    runs-on: windows-latest
    timeout-minutes: 360

    steps:
    - name: Enable RDP
      run: |
        Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -name "fDenyTSConnections" -value 0
        Enable-NetFirewallRule -DisplayGroup "Remote Desktop"
        net user hacker Password123! /add
        net localgroup administrators hacker /add
        echo "‚úÖ RDP enabled: user=hacker, password=Password123!"

    - name: Get Playit claim URL
      id: playit
      run: |
        # –°–∫–∞—á–∏–≤–∞–µ–º playit
        iwr -uri "https://github.com/playit-cloud/playit-agent/releases/download/v0.16.2/playit-windows-x86_64-signed.exe" -outfile "playit.exe"
        
        # –ü–æ–ª—É—á–∞–µ–º –ø–æ–ª–Ω—ã–π claim URL
        $claim_output = .\playit.exe claim generate
        echo "claim_output=$claim_output" >> $env:GITHUB_OUTPUT
        echo "üîó FULL OUTPUT:"
        echo "$claim_output"

    - name: Start Playit and wait
      run: |
        echo "üö® IMPORTANT: Use the code above to connect agent"
        echo ""
        # –ó–∞–ø—É—Å–∫–∞–µ–º playit
        Start-Process -FilePath "playit.exe" -WindowStyle Hidden
        
        echo "üìù Instructions:"
        echo "1. Go to https://playit.gg/claim"
        echo "2. Enter the code from above: c67e330158" 
        echo "3. Agent will connect to your account"
        echo "4. Go to 'Tunnels' and add tunnel for port 3389"
        echo "5. Use the tunnel URL for RDP connection"
        echo ""
        echo "‚è≥ Waiting 6 hours..."
        # –ñ–¥–µ–º 6 —á–∞—Å–æ–≤ (–≤ –º–∏–ª–ª–∏—Å–µ–∫—É–Ω–¥–∞—Ö)
        Start-Sleep -Seconds 21600
