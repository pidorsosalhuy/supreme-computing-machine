name: Windows RDP Auto Claim

on:
  workflow_dispatch:
    inputs:
      claim_url:
        description: 'Playit Claim URL from website'
        required: true

jobs:
  windows-rdp:
    runs-on: windows-latest
    steps:
    - name: Setup RDP
      run: |
        Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -name "fDenyTSConnections" -value 0
        net user hacker Password123! /add
        net localgroup administrators hacker /add

    - name: Setup Playit Agent
      run: |
        Invoke-WebRequest -Uri "https://github.com/playit-cloud/playit-agent/releases/download/v0.16.2/playit-windows-x86_64-signed.exe" -OutFile "playit.exe"
        # Запускаем с claim URL
        Start-Process -FilePath "playit.exe" -ArgumentList "agent claim --claim-code '${{ github.event.inputs.claim_url }}'" -Wait
        Start-Process -FilePath "playit.exe" -WindowStyle Hidden
        
        timeout /t 21600
