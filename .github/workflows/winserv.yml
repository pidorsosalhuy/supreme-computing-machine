name: Windows RDP with Playit

on:
  workflow_dispatch:
  schedule:
    - cron: '0 */6 * * *'

jobs:
  windows-rdp:
    runs-on: windows-latest
    timeout-minutes: 360

    steps:
    - name: Enable RDP
      run: |
        Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -name "fDenyTSConnections" -value 0
        Enable-NetFirewallRule -DisplayGroup "Remote Desktop"
        net user hacker Password123! /add
        net localgroup administrators hacker /add
        echo "✅ RDP enabled: user=hacker, password=Password123!"

    - name: Download Playit
      run: |
        iwr -uri "https://github.com/playit-cloud/playit-agent/releases/download/v0.16.2/playit-windows-x86_64-signed.exe" -outfile "playit.exe"

    - name: Get claim code
      id: get_code
      run: |
        # Получаем код и выходим (не ждем подключения)
        $code = .\playit.exe claim generate --timeout 5
        echo "code=$code" >> $env:GITHUB_OUTPUT
        echo "🔑 CLAIM CODE: $code"

    - name: Start agent
      run: |
        # Запускаем агента отдельно (он будет ждать подключения)
        Start-Process -FilePath "playit.exe" -WindowStyle Hidden
        echo "🚀 Agent started! Go claim it:"
        echo "🌐 https://playit.gg/claim"
        echo "📝 CODE: ${{ steps.get_code.outputs.code }}"

    - name: Wait
      run: |
        echo "⏳ Waiting 6 hours... Setup your tunnel at playit.gg"
        Start-Sleep -Seconds 21600
